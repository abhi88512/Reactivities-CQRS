# Section 15: Implementing Client-Side Attendance Feature

## Overview

### Definition
This section focuses on implementing the client-side attendance feature for an application using React and React Query, enhancing the user interface to display and manage activity attendees, hosts, and related functionalities like joining or canceling activities.

### Purpose
To make the application’s activity management functional by integrating real-time data updates, such as displaying attendees, hosts, and enabling user interactions (e.g., joining or canceling activities) with optimistic updates for a smoother user experience.

### Key Idea
The attendance feature allows users to view and manage activity participation dynamically, leveraging React Query for data fetching and optimistic updates to enhance responsiveness.

> **Analogy**: Think of the attendance feature like a guest list for a party. You can see who’s coming, add or remove yourself instantly, and the list updates without waiting for the host to confirm every change, but it reverts if something goes wrong.

## Learning Goals
- **Understand React Query Enhancements**: Learn how to use React Query’s `select` method and optimistic updates to transform and manage data efficiently.
- **Implement Dynamic UI Updates**: Enable real-time UI updates for activity attendance, including host and attendee details.
- **Handle User Interactions**: Create functional buttons for joining, canceling, and managing activities with appropriate UI feedback.

## Setting Up Activity Types

### Definition
Extend the `Activity` type to include properties for attendees, host details, and user-specific flags (`isGoing`, `isHost`).

### Implementation
- Add new properties to the `Activity` type in `Index.ts`:
  ```typescript
  attendees: Profile[];
  isGoing: boolean;
  isHost: boolean;
  hostId: string;
  hostDisplayName: string;
  ```
- Define a `Profile` type for attendees:
  ```typescript
  type Profile = {
    id: string;
    displayName: string;
    bio?: string;
    imageUrl?: string;
  };
  ```
- Transform API data in the `useActivities` hook using the `select` method to compute `isHost` and `isGoing`:
  ```typescript
  useQuery({
    queryKey: ['activities'],
    queryFn: fetchActivities,
    select: (data) => data.map(activity => ({
      ...activity,
      isHost: currentUser.id === activity.hostId,
      isGoing: activity.attendees.some(x => x.id === currentUser.id)
    }))
  });
  ```
  - Similar transformation for individual activity queries.

### Key Idea
The `select` method allows transforming API data to include computed properties based on the current user, enhancing the activity data for UI rendering.

## Updating Activity Cards

### Definition
Modify the `ActivityCard` component to display dynamic host and attendee information, replacing hardcoded placeholders.

### Implementation
- Remove hardcoded constants for `isHost`, `isGoing`, and `isCancelled`.
- Update the host display:
  ```jsx
  <Link to={`/profiles/${activity.hostId}`}>
    Hosted by {activity.hostDisplayName}
  </Link>
  ```
- Display attendees using Material-UI’s `Avatar` component:
  ```jsx
  {activity.attendees.map(at => (
    <Avatar
      key={at.id}
      alt={`${at.displayName} image`}
      src={at.imageUrl}
      component={Link}
      to={`/profiles/${at.id}`}
    />
  ))}
  ```
- Update labels and colors based on `activity.isHost` and `activity.isGoing`.

### Key Idea
Dynamic rendering of activity cards ensures accurate host and attendee information, with links to profiles for enhanced navigation.

## Creating Profile Popover

### Definition
Add a popover component to display user profile details when hovering over an attendee’s avatar.

### Implementation
- Create `AvatarPopover.tsx` using Material-UI’s `Popover` component:
  ```jsx
  import { Popover, Avatar } from '@mui/material';
  import { Link } from 'react-router-dom';
  import ProfileCard from './ProfileCard';

  type Props = { profile: Profile };

  const AvatarPopover = ({ profile }: Props) => {
    const [anchorEl, setAnchorEl] = React.useState<HTMLElement | null>(null);
    const handlePopoverOpen = (event: React.MouseEvent<HTMLElement>) => {
      setAnchorEl(event.currentTarget);
    };
    const handlePopoverClose = () => {
      setAnchorEl(null);
    };
    const open = Boolean(anchorEl);

    return (
      <>
        <Avatar
          alt={`${profile.displayName} image`}
          src={profile.imageUrl}
          component={Link}
          to={`/profiles/${profile.id}`}
          onMouseEnter={handlePopoverOpen}
          onMouseLeave={handlePopoverClose}
        />
        <Popover
          open={open}
          anchorEl={anchorEl}
          anchorOrigin={{ vertical: 'bottom', horizontal: 'left' }}
          transformOrigin={{ vertical: 'top', horizontal: 'left' }}
        >
          <ProfileCard profile={profile} />
        </Popover>
      </>
    );
  };

  export default AvatarPopover;
  ```
- Replace `Avatar` in `ActivityCard` with `AvatarPopover`:
  ```jsx
  <AvatarPopover key={at.id} profile={at} />
  ```

### Key Idea
The popover enhances user experience by providing quick profile previews without navigating away from the activity card.

## Updating Activity Details

### Definition
Enhance the `ActivityDetails` component, including the header and sidebar, to reflect dynamic host, attendee, and attendance status.

### Implementation
- **Header Updates**:
  - Remove hardcoded constants and update host display:
    ```jsx
    <Link to={`/profiles/${activity.hostId}`}>
      Hosted by {activity.hostDisplayName}
    </Link>
    ```
  - Update buttons based on `activity.isHost`, `activity.isGoing`, and `activity.isCancelled`:
    ```jsx
    {activity.isHost ? (
      <StyledButton
        onClick={() => updateAttendance.mutate(activity.id)}
        disabled={updateAttendance.isPending}
      >
        {activity.isCancelled ? 'Reactivate Activity' : 'Cancel Activity'}
      </StyledButton>
    ) : (
      <StyledButton
        onClick={() => updateAttendance.mutate(activity.id)}
        disabled={updateAttendance.isPending || activity.isCancelled}
      >
        {activity.isGoing ? 'Cancel Attendance' : 'Join Activity'}
      </StyledButton>
    )}
    ```
- **Sidebar Updates**:
  - Pass `activity` prop to `ActivityDetailsSidebar`:
    ```jsx
    <ActivityDetailsSidebar activity={activity} />
    ```
  - Display attendee count and list:
    ```jsx
    <Typography>{activity.attendees.length} people going</Typography>
    {activity.attendees.map(attendee => (
      <Grid key={attendee.id}>
        <Avatar
          alt={`${attendee.displayName} image`}
          src={attendee.imageUrl}
          variant="rounded"
          sx={{ width: 75, height: 75, mr: 3 }}
        />
        <Typography>{attendee.displayName}</Typography>
        {attendee.id === activity.hostId && <Typography>Host</Typography>}
      </Grid>
    ))}
    ```
  - Adjust styling for larger avatars and better layout:
    ```jsx
    sx={{ whiteSpace: 'nowrap', mx: 2 }}
    ```

### Key Idea
The `ActivityDetails` component dynamically reflects activity status and user interactions, with improved styling for better usability.

## Handling Button Styling Issues

### Definition
Fix issues with Material-UI buttons disappearing when disabled over images by creating a styled button component.

### Implementation
- Create `StyledButton.tsx`:
  ```jsx
  import { styled } from '@mui/material/styles';
  import Button from '@mui/material/Button';
  import { ButtonProps } from '@mui/material';
  import { LinkProps } from 'react-router-dom';

  type StyledButtonProps = ButtonProps & Partial<LinkProps>;

  const StyledButton = styled(Button)<StyledButtonProps>(({ theme }) => ({
    '&.Mui-disabled': {
      backgroundColor: theme.palette.grey[600],
      color: theme.palette.text.disabled,
    },
  }));

  export default StyledButton;
  ```
- Replace `Button` with `StyledButton` in `ActivityDetailsHeader` for buttons with `disabled` props.

### Key Idea
Custom styling ensures disabled buttons remain visible, improving the user interface’s consistency.

## Implementing Optimistic Updates

### Definition
Use React Query’s optimistic updates to instantly update the UI when joining or canceling attendance, rolling back on errors.

### Implementation
- Add `updateAttendance` mutation in `useActivities` hook:
  ```typescript
  const updateAttendance = useMutation({
    mutationFn: async (id: string) => {
      await agent.post(`/activities/${id}/attend`);
    },
    onMutate: async (activityId: string) => {
      await queryClient.cancelQueries(['activities', activityId]);
      const prevActivity: Activity = queryClient.getQueryData(['activities', activityId]);
      queryClient.setQueryData(['activities', activityId], (oldActivity: Activity) => {
        if (!oldActivity || !currentUser) return oldActivity;
        const isHost = oldActivity.hostId === currentUser.id;
        const isAttending = oldActivity.attendees.some(x => x.id === currentUser.id);
        return {
          ...oldActivity,
          isCancelled: isHost ? !oldActivity.isCancelled : oldActivity.isCancelled,
          attendees: isHost
            ? oldActivity.attendees
            : isAttending
            ? oldActivity.attendees.filter(x => x.id !== currentUser.id)
            : [
                ...oldActivity.attendees,
                {
                  id: currentUser.id,
                  displayName: currentUser.displayName,
                  imageUrl: currentUser.imageUrl,
                },
              ],
        };
      });
      return { prevActivity };
    },
    onError: (error, activityId, context) => {
      if (context?.prevActivity) {
        queryClient.setQueryData(['activities', activityId], context.prevActivity);
      }
      console.log(error);
    },
  });
  ```

### Key Idea
Optimistic updates improve perceived performance by updating the UI immediately, with rollback mechanisms to handle errors.

## Fixing Scroll Restoration

### Definition
Ensure the page scrolls to the top when navigating to activity details.

### Implementation
- Add `ScrollRestoration` from `react-router-dom` in `App.tsx`:
  ```jsx
  import { ScrollRestoration } from 'react-router-dom';
  // ...
  <ScrollRestoration />
  <CssBaseline />
  ```

### Key Idea
Scroll restoration enhances navigation by resetting the scroll position, improving user experience.

## Key Commands Recap
- **Update Activity Type**: Add `attendees`, `isGoing`, `isHost`, `hostId`, `hostDisplayName` in `Index.ts`.
- **Run Application**: Use `npm start` to test changes locally.
- **Commit Changes**: `git add .`, `git commit -m "End of section 15"`, `git push` to sync with GitHub.

## Tips for Beginners
- **Understand React Query’s `select`**: Use it to transform API data for easier UI integration.
- **Test Optimistic Updates**: Simulate API errors (e.g., bad request) to ensure rollback works correctly.
- **Check Console Logs**: Use `console.log` to debug query keys and data mismatches.
- **Style Consistently**: Ensure disabled buttons remain visible with custom styling to avoid UI confusion.

## Next Steps
- Implement profile routes and pages to support profile links.
- Enhance comment functionality in `ActivityDetails`.
- Refine UI styling for better responsiveness and aesthetics.